# Spotify My Most Played Artists Playlist Generator

Spotifyの長期ストリーミング履歴データ(JSON)から、
「よく聴くアーティスト順 → 各アーティスト内でよく聴く曲順」に基づいたプレイリストを**自動生成**するPythonアプリケーションです。
さらに同一順序の**CSVファイル**も同時に出力します。

---

## 🚀 概要

このスクリプトは、Spotify公式サイトからダウンロードできる「長期ストリーミング履歴」データをもとに、あなたが最も聴いているアーティストと曲を分析し、
Spotify APIを通じて自動的にプレイリストを作成します。

プレイリスト説明欄には、実行コマンドと生成元が明記されます：

```
Generated by Spotify My Most Played Artists Playlist Generator | Command: python cli.py ...
```

同名プレイリストはそのまま新規作成されます（上書きや連番付与は行いません）。

---

## 🧩 機能一覧

* Spotify履歴(JSON)からの統合読み込み
* 曲・アーティストごとの総再生時間集計
* 「アーティスト別の再生量」→「各アーティスト内での曲の再生量」順に並べ替え
* 任意条件によるフィルタリング：

  * 年度範囲 (`--year_start`, `--year_end`)
  * 最小再生時間 (`--min_play_ms`)
  * 曲単位の総再生時間 (`--min_track_total_ms`)
  * アーティストフィルタファイル (`--artists_filter_file` + `--artists_filter_mode`)
* 生成順序のCSV出力（UTF-8 with BOM / CRLF）
* コンソールに進行状況を逐次表示

---

## 🧭 ディレクトリ構成

```
spotify-my-most-played-artists-playlist-generator/
├─ cli.py                         # CLIエントリポイント
├─ generator.py                   # プレイリスト生成ロジック
├─ README.md                      # このファイル
├─ requirements.txt               # 依存パッケージ
├─ .env.example                   # Spotify API認証設定のテンプレート
├─ source_data/                   # Spotify履歴JSON配置場所
├─ csv/                           # 出力CSV保存場所
└─ filters/
   └─ artists.txt                 # アーティストフィルタ（任意）
```

---

## ⚙️ セットアップ手順

### 1. Spotify履歴データの取得

1. [https://www.spotify.com/jp/account/privacy/](https://www.spotify.com/jp/account/privacy/) にアクセス。
2. 「**アカウントのプライバシー設定**」→「**アカウントデータをダウンロード**」からリクエスト。
3. 数日後に届くメールからZIPをダウンロードし、展開。
4. 中の `Streaming_History_Audio_*.json` ファイルを、
   このプロジェクトの `source_data/` ディレクトリへコピー。

### 2. 環境構築

```bash
python -m venv venv
source venv/bin/activate  # Windows: venv\Scripts\activate
pip install -r requirements.txt
```

### 3. Spotify API認証設定

1. [Spotify for Developers](https://developer.spotify.com/dashboard/) にアクセス。
2. アプリを作成し、以下の3つの情報をコピー：

   * `Client ID`
   * `Client Secret`
   * `Redirect URI`（例: `http://127.0.0.1:8080/callback`）
3. `.env.example` をコピーして `.env` を作成し、値を設定：

```bash
SPOTIPY_CLIENT_ID=your_client_id_here
SPOTIPY_CLIENT_SECRET=your_client_secret_here
SPOTIPY_REDIRECT_URI=http://127.0.0.1:8080/callback
```

---

## 💻 実行方法

基本コマンド：

```bash
python cli.py --playlist_name "My Most Played Artists"
```

### 🔸 主要オプション一覧

| オプション                   | 説明                                        | 例                       | デフォルト                    |
| ----------------------- | ----------------------------------------- | ----------------------- | ------------------------ |
| `--playlist_name`       | 作成するプレイリスト名                               | `"2025 Recap"`          | `My Most Played Artists` |
| `--year_start`          | 集計開始年                                     | `2023`                  | None                     |
| `--year_end`            | 集計終了年                                     | `2025`                  | None                     |
| `--top_artists`         | 上位アーティスト数                                 | `50`                    | `30`                     |
| `--tracks_per_artist`   | 各アーティスト内の曲数上限                             | `10`                    | `5`                      |
| `--min_play_ms`         | 単回再生の最小再生時間 (ms)                          | `60000`                 | `30000`                  |
| `--min_track_total_ms`  | 曲単位の総再生時間しきい値 (ms)                        | `120000`                | None                     |
| `--artists_filter_file` | 除外/包含アーティストリスト                            | `./filters/artists.txt` | None                     |
| `--artists_filter_mode` | `exclude` = 除外 / `include` = そのアーティストのみ採用 | `include`               | `exclude`                |
| `--source_dir`          | JSON配置ディレクトリ                              | `./source_data`         | `./source_data`          |

---

## 🧪 実行例

### 🎧 最小実行例

```bash
python cli.py --playlist_name "My Most Played Artists"
```

### 🚫 特定アーティストを除外

```bash
python cli.py \
  --playlist_name "Without Some" \
  --artists_filter_file ./filters/artists.txt \
  --artists_filter_mode exclude
```

### 🎯 特定アーティストのみで生成

```bash
python cli.py \
  --playlist_name "Only These Artists" \
  --artists_filter_file ./filters/artists.txt \
  --artists_filter_mode include
```

### ⏱ 曲総再生時間 2分超を採用

```bash
python cli.py --min_track_total_ms 120000
```

### 📅 2024〜2025年の履歴のみ対象

```bash
python cli.py --year_start 2024 --year_end 2025
```

---

## 📁 出力物

* **Spotify上のプレイリスト**
  自動的にSpotifyアカウントへ作成されます。説明欄に実行コマンドが記録されます。

* **CSVファイル**
  `csv/playlist_<playlist_name>_<日時>.csv` 形式で保存されます。
  （UTF-8 BOM / CRLF / Excel互換）

---

## 🧱 フィルタファイルの書き方

`filters/artists.txt`

```txt
# コメント行
beatles
ヨルシカ
taylor swift
```

※ 大文字小文字を区別しません。部分一致で判定します。

---

## 🛠 トラブルシューティング

| 問題                                   | 対応策                                                           |
| ------------------------------------ | ------------------------------------------------------------- |
| `spotipy.oauth2.SpotifyOauthError`   | `.env`の`Redirect URI`がSpotify Developer Dashboardに登録されているか確認。 |
| `No valid Spotify track URIs to add` | 条件が厳しすぎる可能性。`--min_play_ms` や `--min_track_total_ms` を緩めて再実行。 |
| プレイリストが空になる                          | 履歴JSONが正しいディレクトリ(`source_data/`)にあるか確認。                       |

---

## 🧾 ライセンス

MIT License

---

## 💡 補足

* Python 3.10 以降を推奨
* 公開状態はSpotify APIの仕様により **自動的にpublic** になります。
* 本ツールはSpotify APIを使用しますが、非公式の個人利用ツールです。